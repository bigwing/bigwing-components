{"version":3,"sources":["@wordpress/components/src/sandbox/index.js"],"names":["Sandbox","arguments","trySandbox","bind","checkMessageForResize","iframe","state","width","height","trySandboxWithoutRerender","current","addEventListener","prevProps","forceRerender","html","props","removeEventListener","contentDocument","body","e","event","data","JSON","parse","contentWindow","source","action","oldWidth","oldHeight","setState","isFrameAccessible","getAttribute","observeAndResizeJS","style","htmlDoc","document","documentElement","lang","type","title","__html","styles","map","rules","i","scripts","src","iframeDocument","open","write","close","onFocus","Math","ceil","Component","message"],"mappings":"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","sourcesContent":["/**\n * WordPress dependencies\n */\nimport { Component, renderToString, createRef } from '@wordpress/element';\nimport { withGlobalEvents } from '@wordpress/compose';\n\n/**\n * Internal dependencies\n */\nimport FocusableIframe from '../focusable-iframe';\n\nclass Sandbox extends Component {\n\tconstructor() {\n\t\tsuper( ...arguments );\n\n\t\tthis.trySandbox = this.trySandbox.bind( this );\n\t\tthis.checkMessageForResize = this.checkMessageForResize.bind( this );\n\n\t\tthis.iframe = createRef();\n\n\t\tthis.state = {\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t};\n\t}\n\n\tcomponentDidMount() {\n\t\tthis.trySandbox();\n\t\tthis.trySandboxWithoutRerender = () => {\n\t\t\tthis.trySandbox( false );\n\t\t};\n\t\t// This used to be registered using <iframe onLoad={} />, but it made the iframe blank\n\t\t// after reordering the containing block. See these two issues for more details:\n\t\t// https://github.com/WordPress/gutenberg/issues/6146\n\t\t// https://github.com/facebook/react/issues/18752\n\t\tthis.iframe.current.addEventListener(\n\t\t\t'load',\n\t\t\tthis.trySandboxWithoutRerender,\n\t\t\tfalse\n\t\t);\n\t}\n\n\tcomponentDidUpdate( prevProps ) {\n\t\tconst forceRerender = prevProps.html !== this.props.html;\n\n\t\tthis.trySandbox( forceRerender );\n\t}\n\n\tcomponentWillUnmount() {\n\t\tthis.iframe.current.removeEventListener(\n\t\t\t'load',\n\t\t\tthis.trySandboxWithoutRerender\n\t\t);\n\t}\n\n\tisFrameAccessible() {\n\t\ttry {\n\t\t\treturn !! this.iframe.current.contentDocument.body;\n\t\t} catch ( e ) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tcheckMessageForResize( event ) {\n\t\tconst iframe = this.iframe.current;\n\n\t\t// Attempt to parse the message data as JSON if passed as string\n\t\tlet data = event.data || {};\n\t\tif ( 'string' === typeof data ) {\n\t\t\ttry {\n\t\t\t\tdata = JSON.parse( data );\n\t\t\t} catch ( e ) {}\n\t\t}\n\n\t\t// Verify that the mounted element is the source of the message\n\t\tif ( ! iframe || iframe.contentWindow !== event.source ) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Update the state only if the message is formatted as we expect, i.e.\n\t\t// as an object with a 'resize' action, width, and height\n\t\tconst { action, width, height } = data;\n\t\tconst { width: oldWidth, height: oldHeight } = this.state;\n\n\t\tif (\n\t\t\t'resize' === action &&\n\t\t\t( oldWidth !== width || oldHeight !== height )\n\t\t) {\n\t\t\tthis.setState( { width, height } );\n\t\t}\n\t}\n\n\ttrySandbox( forceRerender = false ) {\n\t\tif ( ! this.isFrameAccessible() ) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst body = this.iframe.current.contentDocument.body;\n\n\t\tif (\n\t\t\t! forceRerender &&\n\t\t\tnull !== body.getAttribute( 'data-resizable-iframe-connected' )\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst observeAndResizeJS = `\n\t\t\t( function() {\n\t\t\t\tvar observer;\n\n\t\t\t\tif ( ! window.MutationObserver || ! document.body || ! window.parent ) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tfunction sendResize() {\n\t\t\t\t\tvar clientBoundingRect = document.body.getBoundingClientRect();\n\n\t\t\t\t\twindow.parent.postMessage( {\n\t\t\t\t\t\taction: 'resize',\n\t\t\t\t\t\twidth: clientBoundingRect.width,\n\t\t\t\t\t\theight: clientBoundingRect.height,\n\t\t\t\t\t}, '*' );\n\t\t\t\t}\n\n\t\t\t\tobserver = new MutationObserver( sendResize );\n\t\t\t\tobserver.observe( document.body, {\n\t\t\t\t\tattributes: true,\n\t\t\t\t\tattributeOldValue: false,\n\t\t\t\t\tcharacterData: true,\n\t\t\t\t\tcharacterDataOldValue: false,\n\t\t\t\t\tchildList: true,\n\t\t\t\t\tsubtree: true\n\t\t\t\t} );\n\n\t\t\t\twindow.addEventListener( 'load', sendResize, true );\n\n\t\t\t\t// Hack: Remove viewport unit styles, as these are relative\n\t\t\t\t// the iframe root and interfere with our mechanism for\n\t\t\t\t// determining the unconstrained page bounds.\n\t\t\t\tfunction removeViewportStyles( ruleOrNode ) {\n\t\t\t\t\tif( ruleOrNode.style ) {\n\t\t\t\t\t\t[ 'width', 'height', 'minHeight', 'maxHeight' ].forEach( function( style ) {\n\t\t\t\t\t\t\tif ( /^\\\\d+(vmin|vmax|vh|vw)$/.test( ruleOrNode.style[ style ] ) ) {\n\t\t\t\t\t\t\t\truleOrNode.style[ style ] = '';\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tArray.prototype.forEach.call( document.querySelectorAll( '[style]' ), removeViewportStyles );\n\t\t\t\tArray.prototype.forEach.call( document.styleSheets, function( stylesheet ) {\n\t\t\t\t\tArray.prototype.forEach.call( stylesheet.cssRules || stylesheet.rules, removeViewportStyles );\n\t\t\t\t} );\n\n\t\t\t\tdocument.body.style.position = 'absolute';\n\t\t\t\tdocument.body.style.width = '100%';\n\t\t\t\tdocument.body.setAttribute( 'data-resizable-iframe-connected', '' );\n\n\t\t\t\tsendResize();\n\n\t\t\t\t// Resize events can change the width of elements with 100% width, but we don't\n\t\t\t\t// get an DOM mutations for that, so do the resize when the window is resized, too.\n\t\t\t\twindow.addEventListener( 'resize', sendResize, true );\n\t\t} )();`;\n\n\t\tconst style = `\n\t\t\tbody {\n\t\t\t\tmargin: 0;\n\t\t\t}\n\t\t\thtml,\n\t\t\tbody,\n\t\t\tbody > div,\n\t\t\tbody > div > iframe {\n\t\t\t\twidth: 100%;\n\t\t\t}\n\t\t\thtml.wp-has-aspect-ratio,\n\t\t\tbody.wp-has-aspect-ratio,\n\t\t\tbody.wp-has-aspect-ratio > div,\n\t\t\tbody.wp-has-aspect-ratio > div > iframe {\n\t\t\t\theight: 100%;\n\t\t\t\toverflow: hidden; /* If it has an aspect ratio, it shouldn't scroll. */\n\t\t\t}\n\t\t\tbody > div > * {\n\t\t\t\tmargin-top: 0 !important; /* Has to have !important to override inline styles. */\n\t\t\t\tmargin-bottom: 0 !important;\n\t\t\t}\n\t\t`;\n\n\t\t// put the html snippet into a html document, and then write it to the iframe's document\n\t\t// we can use this in the future to inject custom styles or scripts.\n\t\t// Scripts go into the body rather than the head, to support embedded content such as Instagram\n\t\t// that expect the scripts to be part of the body.\n\t\tconst htmlDoc = (\n\t\t\t<html\n\t\t\t\tlang={ document.documentElement.lang }\n\t\t\t\tclassName={ this.props.type }\n\t\t\t>\n\t\t\t\t<head>\n\t\t\t\t\t<title>{ this.props.title }</title>\n\t\t\t\t\t<style dangerouslySetInnerHTML={ { __html: style } } />\n\t\t\t\t\t{ this.props.styles &&\n\t\t\t\t\t\tthis.props.styles.map( ( rules, i ) => (\n\t\t\t\t\t\t\t<style\n\t\t\t\t\t\t\t\tkey={ i }\n\t\t\t\t\t\t\t\tdangerouslySetInnerHTML={ { __html: rules } }\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t) ) }\n\t\t\t\t</head>\n\t\t\t\t<body\n\t\t\t\t\tdata-resizable-iframe-connected=\"data-resizable-iframe-connected\"\n\t\t\t\t\tclassName={ this.props.type }\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tdangerouslySetInnerHTML={ { __html: this.props.html } }\n\t\t\t\t\t/>\n\t\t\t\t\t<script\n\t\t\t\t\t\ttype=\"text/javascript\"\n\t\t\t\t\t\tdangerouslySetInnerHTML={ {\n\t\t\t\t\t\t\t__html: observeAndResizeJS,\n\t\t\t\t\t\t} }\n\t\t\t\t\t/>\n\t\t\t\t\t{ this.props.scripts &&\n\t\t\t\t\t\tthis.props.scripts.map( ( src ) => (\n\t\t\t\t\t\t\t<script key={ src } src={ src } />\n\t\t\t\t\t\t) ) }\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t);\n\n\t\t// writing the document like this makes it act in the same way as if it was\n\t\t// loaded over the network, so DOM creation and mutation, script execution, etc.\n\t\t// all work as expected\n\t\tconst iframeDocument = this.iframe.current.contentWindow.document;\n\t\tiframeDocument.open();\n\t\tiframeDocument.write( '<!DOCTYPE html>' + renderToString( htmlDoc ) );\n\t\tiframeDocument.close();\n\t}\n\n\tstatic get defaultProps() {\n\t\treturn {\n\t\t\thtml: '',\n\t\t\ttitle: '',\n\t\t};\n\t}\n\n\trender() {\n\t\tconst { title, onFocus } = this.props;\n\n\t\treturn (\n\t\t\t<FocusableIframe\n\t\t\t\tiframeRef={ this.iframe }\n\t\t\t\ttitle={ title }\n\t\t\t\tclassName=\"components-sandbox\"\n\t\t\t\tsandbox=\"allow-scripts allow-same-origin allow-presentation\"\n\t\t\t\tonFocus={ onFocus }\n\t\t\t\twidth={ Math.ceil( this.state.width ) }\n\t\t\t\theight={ Math.ceil( this.state.height ) }\n\t\t\t/>\n\t\t);\n\t}\n}\n\nSandbox = withGlobalEvents( {\n\tmessage: 'checkMessageForResize',\n} )( Sandbox );\n\nexport default Sandbox;\n"]}